#include <stdio.h>

#define MAX 10   // Maximum number of processes/resources

int n, m;                          // n = processes, m = resources
int alloc[MAX][MAX], max[MAX][MAX], need[MAX][MAX];
int avail[MAX], total[MAX];        // Added total[]
int safeSeq[MAX];                  // To store safe sequence

// --------------------- Function to check if system is in safe state ---------------------
int isSafe() {
    int work[MAX], finish[MAX] = {0};
    int count = 0;

    // Initialize work = avail
    for (int i = 0; i < m; i++)
        work[i] = avail[i];

    // Try to find all processes that can finish
    while (count < n) {
        int found = 0;
        for (int p = 0; p < n; p++) {
            if (finish[p] == 0) {
                int canRun = 1;
                for (int j = 0; j < m; j++) {
                    if (need[p][j] > work[j]) {
                        canRun = 0;
                        break;
                    }
                }

                if (canRun) {
                    for (int k = 0; k < m; k++)
                        work[k] += alloc[p][k];  // Release resources
                    safeSeq[count++] = p;
                    finish[p] = 1;
                    found = 1;
                }//if canalloc
            }//!finish
        }//for loop outer
        if (!found) break; // No process can proceed => unsafe
    }

    if (count == n) {
        printf("\nSystem is in a SAFE state.\nSafe Sequence: ");
        for (int i = 0; i < n; i++) {
            printf("P%d", safeSeq[i]);
            if (i != n - 1) printf(" -> ");
        }
        printf("\n");
        return 1; // Safe
    } else {
        printf("\nSystem is NOT in a safe state.\n");
        return 0; // Unsafe
    }
}

// --------------------- Function to handle resource request ---------------------
void requestResources() {
    int p, req[MAX];

    printf("\nEnter process number to make a request (-1 to exit): ");
    scanf("%d", &p);

    if (p < 0 || p >= n) {
        printf("Exiting resource request section.\n");
        return;
    }

    printf("Enter request vector for P%d: ", p);
    for (int i = 0; i < m; i++)
        scanf("%d", &req[i]);

    // Step 1: Request <= Need ?
    for (int i = 0; i < m; i++) {
        if (req[i] > need[p][i]) {
            printf("Error: Process requested more than its maximum need!\n");
            return;
        }
    }

    // Step 2: Request <= Available ?
    for (int i = 0; i < m; i++) {
        if (req[i] > avail[i]) {
            printf("Resources not available. Process must wait.\n");
            return;
        }
    }

    // Step 3: Pretend to allocate
    for (int i = 0; i < m; i++) {
        avail[i] -= req[i];
        alloc[p][i] += req[i];
        need[p][i] -= req[i];
    }

    // Step 4: Check if still safe
    if (isSafe()) {
        printf("Request can be granted safely.\n");
    } else {
        printf("Request cannot be granted (unsafe state).\n");
        // Rollback
        for (int i = 0; i < m; i++) {
            avail[i] += req[i];
            alloc[p][i] -= req[i];
            need[p][i] += req[i];
        }
    }
}

// --------------------- Main Function ---------------------
int main() {
    printf("Enter number of processes: ");
    scanf("%d", &n);

    printf("Enter number of resource types: ");
    scanf("%d", &m);

    // Input Allocation Matrix
    printf("\nEnter Allocation Matrix (%d x %d):\n", n, m);
    for (int i = 0; i < n; i++) {
        printf("P%d: ", i);
        for (int j = 0; j < m; j++)
            scanf("%d", &alloc[i][j]);
    }

    // Input Max Matrix
    printf("\nEnter Max Matrix (%d x %d):\n", n, m);
    for (int i = 0; i < n; i++) {
        printf("P%d: ", i);
        for (int j = 0; j < m; j++)
            scanf("%d", &max[i][j]);
    }

    // Input Total Resources
    printf("\nEnter Total Resources (size %d): ", m);
    for (int i = 0; i < m; i++)
        scanf("%d", &total[i]);

    // Calculate Available = Total - sum(Allocation)
    for (int j = 0; j < m; j++) {
        int sum_alloc = 0;
        for (int i = 0; i < n; i++)
            sum_alloc += alloc[i][j];
        avail[j] = total[j] - sum_alloc;//note index->  “ j “
    }

    // Display Available Resources
    printf("\nCalculated Available Resources: ");
    for (int i = 0; i < m; i++)
        printf("%d ", avail[i]);
    printf("\n");

    // Calculate Need = Max - Alloc
    for (int i = 0; i < n; i++)
        for (int j = 0; j < m; j++)
            need[i][j] = max[i][j] - alloc[i][j];

    // Display Need Matrix
    printf("\nNeed Matrix:\n");
    for (int i = 0; i < n; i++) {
        printf("P%d: ", i);
        for (int j = 0; j < m; j++)
            printf("%d ", need[i][j]);
        printf("\n");
    }

    // Step 1: Check initial safety
    isSafe();

    // Step 2: Handle resource requests
    while (1)
        requestResources();

    return 0;
}
 
